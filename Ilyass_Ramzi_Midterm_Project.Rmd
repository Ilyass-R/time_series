---
title: 'Midterm Project: Travel Distance'
author: "Ilyass Ramzi"
date: "UC3M, 2024"
output:
  html_document:
    df_print: paged
subtitle: "Time Series Analysis and Forecasting - Master in Big Data Analytics"
editor_options:
  chunk_output_type: inline
---

# Introduction

This analysis embarks on an exploration of mobility trends within the United States, focusing specifically on the dynamics of at-home stays versus travel distances by the populace. Leveraging the comprehensive ["Trips by Distance"](https://data.bts.gov/Research-and-Statistics/Trips-by-Distance/w96p-f2qv/data_preview) dataset, alongside metrics detailing the count of individuals staying at or away from home, this study draws on estimates generated by the Bureau of Transportation Statistics, in collaboration with the Maryland Transportation Institute and the Center for Advanced Transportation Technology Laboratory at the University of Maryland. These estimates are derived from a robust anonymized dataset encompassing a national panel of mobile device data sourced from multiple providers, ensuring no personal information is implicated.

This investigation adheres to a stringent definition of trips, categorizing them as any movement that involves a stay exceeding 10 minutes at a location distinct from the individual's home, with these home locations determined on a weekly basis. Such trips encompass all forms of transportation, including but not limited to driving, rail, transit, and air travel, thereby offering a holistic view of mobility patterns across different modes of transport.

The dataset underpins its reliability on a merged data panel that integrates mobile device data from various sources, addressing common issues of geographic and temporal sample variation. This integration only includes devices that meet a rigorous set of data quality standards concerning the temporal frequency and spatial accuracy of anonymized location data, among other criteria. These standards ensure the overall quality and consistency of the dataset. To account for representativeness at both device and trip levels, a multi-level weighting methodology is employed, expanding the sample size to accurately reflect the underlying population demographics at the county and state levels.

The integrity of this data analysis is maintained through a confidentiality protocol that withholds reporting for any county with fewer than 50 devices in the sample on any given day, ensuring data privacy and reliability. Through this detailed examination, our analysis aims to shed light on the intricate patterns of home stays and travel distances, offering insights into the mobility behaviors of states and counties within the United States.

## Motivation and Rationale

The utilization of this dataset, provides a unique opportunity for in-depth time series analysis and forecasting. This dataset, enriched with anonymized mobile device data and weighted to represent the broader population accurately, offers a granular view of mobility trends at national, state, and county levels. The comprehensive nature of the data allows for an exploration of patterns in how far people travel, the frequency of their trips, and the propensity of individuals to stay home, giving us a detailed picture of mobility in various regions.

The motivation behind selecting this specific dataset for the project lies in its potential to uncover significant insights into travel behaviors and patterns over time. By analyzing this data, we can identify trends, seasonal variations, and anomalies in travel movements, which are crucial for understanding the broader implications of mobility on society and the environment. This analysis not only serves an academic purpose but also provides practical insights that can inform policy decisions, urban planning, and transportation services.

Furthermore, the rationale for focusing on this dataset encompasses its relevance in the current socio-economic context, where understanding mobility patterns is essential for addressing challenges related to urban congestion, environmental sustainability, and public health. The insights generated through time series analysis and forecasting can contribute to more informed and effective strategies for managing mobility and enhancing the quality of life in communities across the nation.

## Dataset Description

The dataset for our analysis, provides a detailed overview of mobility trends within Florida's counties. Due to hardware limitations and the extensive size of the original dataset, which spanned over 7GB covering all U.S. states and counties, we have narrowed our focus to Florida given its significant volume of data entries. This subset allows for a more manageable analysis while still offering comprehensive insights into travel behaviors within a key geographical area.

This dataset encompasses several variables, including the date of travel, the county of observation, and various categories of trips based on distance ranges (e.g., 1-3 miles, 3-5 miles, etc.). It also includes metrics on the number of people staying at home versus not staying at home, providing a multifaceted view of mobility patterns.

The dataset is collected on a **daily** basis, extending from **January 1, 2019**, to **February 10, 2024**. This period encapsulates the evolution of mobility patterns through both pre-pandemic and pandemic phases, along with the gradual changes occurring in the subsequent months. The daily frequency of the data provides a granular view into the fluctuations of travel behaviors, influenced by a variety of factors over time.

### Columns in the Dataset

The columns in the dataset are summarized in the following table:

| Column Name                    | Description                                                                    | Type               |
|-------------------|----------------------------------|-------------------|
| Level                          | Indicates National, State, or County level metrics                             | Categorical (Text) |
| Date                           | Date                                                                           | Date & Time        |
| State FIPS                     | Two-digit FIPS state code                                                      | Integer (Count)    |
| State Postal Code              | State postal code                                                              | Categorical (Text) |
| County FIPS                    | Five-digit FIPS county code                                                    | Integer (Count)    |
| County Name                    | County name                                                                    | Categorical (Text) |
| Population Staying at Home     | Number of residents staying at home                                            | Integer (Count)    |
| Population Not Staying at Home | Number of residents not staying at home                                        | Integer (Count)    |
| Number of Trips                | Total number of trips made by residents                                        | Integer (Count)    |
| Number of Trips \<1            | Number of trips by residents shorter than one mile                             | Integer (Count)    |
| Number of Trips 1-3            | Number of trips by residents greater than one mile and shorter than 3 miles    | Integer (Count)    |
| Number of Trips 3-5            | Number of trips by residents greater than 3 miles and shorter than 5 miles     | Integer (Count)    |
| Number of Trips 5-10           | Number of trips by residents greater than 5 miles and shorter than 10 miles    | Integer (Count)    |
| Number of Trips 10-25          | Number of trips by residents greater than 10 miles and shorter than 25 miles   | Integer (Count)    |
| Number of Trips 25-50          | Number of trips by residents greater than 25 miles and shorter than 50 miles   | Integer (Count)    |
| Number of Trips 50-100         | Number of trips by residents greater than 50 miles and shorter than 100 miles  | Integer (Count)    |
| Number of Trips 100-250        | Number of trips by residents greater than 100 miles and shorter than 250 miles | Integer (Count)    |
| Number of Trips 250-500        | Number of trips by residents greater than 250 miles and shorter than 500 miles | Integer (Count)    |
| Number of Trips \>=500         | Number of trips by residents greater than 500 miles                            | Integer (Count)    |
| Row ID                         | Unique row identifier                                                          | Categorical (Text) |
| Week                           | Week number                                                                    | Integer (Count)    |
| Month                          | Month number                                                                   | Integer (Count)    |

These variables are essential for understanding the dynamics of travel within the state, including short-distance commuting patterns and longer excursions, as well as the propensity of residents to remain within their homes.

# Preliminary Data Exploration

### Libraries

The following chunk includes the libraries that will be used for this analysis:

```{r}
# Ensure the environment is clean
rm(list=ls())

# Load libraries
library(tidyverse)
library(fpp3)
library(dygraphs)
library(rlang)
library(conflicted)
```

Now, that the required libraries have been loaded. Let's start our analysis by loading the dataset and inspecting its data structure.

```{r}
trip_data = read.csv("Trips_by_Distance_FL_County.csv")
```

```{r}
str(trip_data)
```

We have a total of $122.342$ observations across $22$ variables, allowing for a comprehensive analysis.

The character type for `Date`, `Week`, and `Month` variables suggests preliminary data processing might be necessary to facilitate time series analysis, particularly converting dates from character strings to a Date or datetime format in R.

### Heads and Tails (of Rows)

Let's have a glimpse into the first and last few rows of the dataset.

```{r}
head(trip_data)
tail(trip_data)
```

Upon inspecting the output, it is confirmed that the dataset commences on **January 1, 2019**, and concludes on **December 31, 2023**, providing a comprehensive temporal scope that encompasses both pre-pandemic and pandemic periods, along with the recovery years of 2022 and the return to normality by 2023. This extensive range offers a valuable perspective on mobility trends and behaviors before, during, and after significant global events.

### Summary of Data

```{r}
summary(trip_data[sapply(trip_data, is.integer)])
```

Some key observations that were found from this brief statistical summary include:

-   **Population Mobility**:
    -   There's notable variability in the population staying at home (`Population.Staying.at.Home`) and not staying at home (`Population.Not.Staying.at.Home`), with a significant range observed (min to max), highlighting diverse mobility patterns across counties.
    -   The presence of NA values in population-related columns suggests missing data for some entries, which may need addressing before in-depth analysis.
-   **Trip Frequencies**:
    -   Trip data across various distance categories (`Number.of.Trips.<1` to `Number.of.Trips...500`) shows a broad range of travel behaviors, from short trips under 1 mile to long trips over 500 miles.
    -   The decrease in trip frequencies as distance increases is expected, but there's substantial variability, suggesting different mobility preferences or needs across the population.
    -   NA values in trip frequency columns also indicate missing data points that require attention.

From this summary, the following considerations should be noted:

-   **Population Mobility Trends**: Analyzing the population staying at home versus not staying at home could reveal insights into how mobility patterns have changed over time, potentially influenced by external factors such as the COVID-19 pandemic.
-   **Trip Distribution Analysis**: Examining the distribution and trends of trips across different distance categories could offer a deeper understanding of travel behavior within the state. This could include exploring the reasons behind the variability in shorter versus longer trips.
-   **Temporal Analysis**: With `Week` and `Month` variables, analyzing mobility patterns on a weekly and monthly basis could uncover seasonal trends or shifts in travel behavior related to specific events or periods (e.g., holidays, school seasons).

### Missing Values

Let's take care of missing values. First of all, let's check how many NA's are in our dataset.

```{r}
sum(is.na(trip_data))
```

Let's have a look at where these NA's are coming from.

```{r}
na_rows <- apply(is.na(trip_data), 1, any)
trip_data_na <- trip_data[na_rows, ]
trip_data_na
```

It seems that we have missing information on trips for $8$ counties on the **26th March 2021**. In order to choose the best approach for handling these NA's, we will be **averaging** adjacent days or interpolation provides a middle ground that accounts for general trends without assuming specific patterns.

Before proceeding with the replacement, we must first ensure `Date` is in the correct format.

```{r}
trip_data$Date <- as.Date(trip_data$Date, format = "%Y/%m/%d")
```

Now, let's define the dates and columns to be updated:

```{r}
before_date <- as.Date("2021/03/25")
after_date <- as.Date("2021/03/27")
missing_date <- as.Date("2021/03/26")

columns_to_replace <- c("Population.Staying.at.Home", "Population.Not.Staying.at.Home", 
                        "Number.of.Trips", "Number.of.Trips..1", "Number.of.Trips.1.3", 
                        "Number.of.Trips.3.5", "Number.of.Trips.5.10", "Number.of.Trips.10.25", 
                        "Number.of.Trips.25.50", "Number.of.Trips.50.100", 
                        "Number.of.Trips.100.250", "Number.of.Trips.250.500", 
                        "Number.of.Trips...500")
```

For simplicity and efficiency, we can loop through each column, calculate the average for the day before and after, and replace the NAs for the missing date.

```{r}
conflicts_prefer(dplyr::filter)

# Loop through each column to replace
for (col in columns_to_replace) {
  # Identify rows for 'before', 'missing', and 'after' dates
  before_rows <- which(trip_data$Date == before_date)
  missing_rows <- which(trip_data$Date == missing_date & is.na(trip_data[[col]]))
  after_rows <- which(trip_data$Date == after_date)
  
  # For each 'missing' county, calculate the average of 'before' and 'after'
  for (row in missing_rows) {
    county_fips <- trip_data$County.FIPS[row]
    
    # Find corresponding 'before' and 'after' rows for the same county
    before_row <- before_rows[trip_data$County.FIPS[before_rows] == county_fips]
    after_row <- after_rows[trip_data$County.FIPS[after_rows] == county_fips]
    
    # Calculate average if both 'before' and 'after' rows exist
    if (length(before_row) == 1 && length(after_row) == 1) {
      avg_value <- mean(c(trip_data[[col]][before_row], trip_data[[col]][after_row]), na.rm = TRUE)
      # Use ceiling() to round up to the nearest whole number
      trip_data[[col]][row] <- ceiling(avg_value)
    }
  }
}
```

```{r}
sum(is.na(trip_data))
```

### Data Visualization

Alright, now that we have handled these missing values, let's move onto initial visual exploration. By plotting variables like `Number of Trips` over time we can identify trends, seasonality, or outliers.

Let's convert our dataset `trip_data` into a `tsibble` object, which is specifically designed for time series analysis, with `Date` serving as the time index and `County.Name` as the key to uniquely identify each time series within the data. This facilitates handling and analyzing time-series data, especially when dealing with multiple groups (counties, in our case) over time.

```{r}
trip_data_ts <- trip_data %>%
  as_tsibble(index = Date, key = County.Name)
```

We can check that it has been converted accordingly:

```{r}
print(class(trip_data_ts))
```

Let's identify the top 5 counties with the highest total number of trips in the dataset by grouping data by **`County.Name`**, summarizing the total trips per county, and then arranging the counties in descending order based on these totals.

```{r}
top_5_counties <- trip_data %>%
  group_by(County.Name) %>%
  summarise(Total_Trips = sum(Number.of.Trips, na.rm = TRUE)) %>%
  arrange(desc(Total_Trips)) %>%
  slice_head(n = 5)

# Display the top 5 counties
print(top_5_counties)
```

```{r}
# Making a list object for the top 5 counties:
top_5_counties <- c("Miami-Dade County", "Broward County", "Palm Beach County", "Hillsborough County", "Orange County")
```

Now, let's visualize the aggregated daily trips over time for these counties, highlighting trends from January 1, 2019, to December 31, 2023, through a time series plot.

```{r}
# Filter, group, and summarise the data
trip_data_ts_all_trips <- trip_data_ts %>%
  filter(County.Name %in% top_5_counties) %>%
  group_by(County.Name) %>%
  summarise(All_Trips = sum(Number.of.Trips, na.rm = TRUE), .groups = 'drop')

# Plot
trip_data_ts_all_trips |> autoplot(All_Trips) + 
  labs(title = "Total Trips over Time", subtitle = "For the top 5 counties with the highest number of trips. From 2019-01-01 to 2023-12-31.", x = "Date", y = "Number of Trips")
```

The plot visualizes the total number of trips over time for the top five counties in the dataset from January 1, 2019, to December 31, 2023. The different colors represent each county, with **Miami-Dade County** (green) showing the highest peaks, indicating a greater number of trips compared to the others.

Upon a closer examination of the dates on the plot, it is observed that there are cyclical patterns in the number of trips, which could be indicative of seasonal behaviors, such as increased travel during holiday seasons or summer months. Additionally, there may be noticeable dips which could correlate with known events or periods, such as reduced travel during the initial outbreak of the COVID-19 pandemic in early 2020. Each county exhibits its unique travel pattern, yet they all appear to follow a general trend that suggests a common influencing factor, possibly related to statewide or national events.

#### Boxplot for Distribution of All Trips

A box plot will allows us to compare the distribution of trips highlighting the median, quartiles and potential outliers. This will bring out any insights into the variability and typical range of trips for our top five counties.

```{r}
ggplot(trip_data_ts_all_trips, aes(x = County.Name, y = All_Trips, fill = County.Name)) +
  geom_boxplot() +
  labs(title = "Distribution of All Trips", subtitle = "Variability and Range of All Trips Across the Top 5 Most Active Florida Counties" , x = "County", y = "Number of Trips") +
  theme(axis.text.x = element_text(angle = 15))
```

The boxplot illustrates the distribution of all trips taken in the top 5 most active Florida counties. It highlights that Miami-Dade County has a notably higher median and wider range of trips, indicating it has more variability in daily travel compared to the other counties. Outliers suggest occasional days with exceptionally high travel numbers, especially in Miami-Dade and Broward Counties.

The outliers in Miami-Dade and Broward Counties could reasonably be attributed to seasonal tourism peaks, such as during spring break, when visitors flock to the beaches and attractions of South Florida. Additionally, special events like music festivals, sports events, or cultural celebrations in these populous counties could also contribute to significant spikes in daily travel numbers.

#### Heatmap of Trip Frequency by Day of Week and Month

A heatmap could show how trip frequencies vary by day of the week and month, potentially revealing patterns such as weekend spikes or monthly variations due to seasonal factors.

```{r}
trip_data %>%
  mutate(DayOfWeek = wday(Date, label = TRUE), Month = month(Date, label = TRUE)) %>%
  group_by(DayOfWeek, Month) %>%
  summarise(Total_Trips = sum(Number.of.Trips, na.rm = TRUE), .groups = 'drop') %>%
  ggplot(aes(x = DayOfWeek, y = Month, fill = Total_Trips)) +
  geom_tile() +
  labs(title = "Heatmap of Trip Frequency by Day of Week and Month", subtitle = "Seasonal and Weekly Patterns in Trip Frequencies Across the Florida Counties", x = "Day of Week", y = "Month")
```

The heatmap indicates particularly high travel frequencies during the winter months, likely due to Florida's appeal as a warm-weather destination, with peaks in travel on Fridays and Saturdays, suggesting weekend travel is more common. Conversely, travel appears to dip in the summer, with the lowest activity on Sundays and Mondays, which may reflect a typical reduction in work-related commutes and weekend getaways concluding. These patterns might be driven by seasonal tourism cycles, local events, and the general workweek structure.

#### Line Plot for Trends in Trip Distances

To better distinguish the trends in trip distances over time, we'll utilize a line plot for a clearer visualization of each trip category. For reference, the following time series will be our focus in the subsequent analysis:

-   **Daily Short Trips (`Number.of.Trips.5.10`)**: These trips are likely to represent regular errands or commutes that can be completed within a local area, such as going to work, school, shopping, or other daily activities that don't require traveling far.

-   **Medium Trips (`Number.of.Trips.50.100`)**: These trips might include travel to neighboring cities or regions, possibly for business, leisure, or occasional needs like visiting family or friends, attending events, or weekend getaways. They are not too long to require extensive planning but are significant enough to go beyond daily routine travel.

-   **Long Trips (`Number.of.Trips.250.500`)**: These trips are generally planned and could be for vacation, long-distance work-related travel, or other infrequent purposes. They cover a range of travel that would typically require more substantial time commitment and could involve staying overnight or for several days at the destination.

```{r}
trip_data_line_plot <- trip_data %>%
  filter(County.Name %in% top_5_counties) %>%
  group_by(Date, County.Name) %>%
  summarise(
    Short_Trips = sum(Number.of.Trips.5.10, na.rm = TRUE),
    Medium_Trips = sum(Number.of.Trips.50.100, na.rm = TRUE),
    Long_Trips = sum(Number.of.Trips.250.500, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  pivot_longer(cols = c(Short_Trips, Medium_Trips, Long_Trips), names_to = "Trip_Type", values_to = "Number_of_Trips") %>%
  ggplot(aes(x = Date, y = Number_of_Trips, color = Trip_Type)) +
  geom_line() +
  labs(title = "Trends in Trip Distances Over Time", subtitle = "Comparative Analysis of Travel Patterns for Short, Medium, and Long Trips in Florida's Top 5 Busiest Counties", x = "Date", y = "Number of Trips", color = "Trip Type")

print(trip_data_line_plot)
```

The plot presents the frequency of short, medium, and long trips in the top 5 busiest counties in Florida over time. Short trips dominate the travel patterns with consistent daily volumes, while medium and long trips show lower frequencies with less variation. The relative stability in short trip numbers suggests a steady demand for local travel, contrasting with the more variable nature of longer journeys.

Medium and long trips are comparatively less frequent, hinting at more occasional travel such as weekend trips or holiday travel. Notably, there are no significant spikes in long trips, which could suggest that such travel is not heavily influenced by seasonal or event-driven factors within the observed timeframe.

Let's take a closer look for the distribution of trips for each of the top five counties, in accordance to their distances:

-   **Short Trips**

```{r}
trip_data_ts |> filter(County.Name %in% top_5_counties) |> autoplot(Number.of.Trips.5.10) + labs(y = "Number of Short Trips", title = "Distribution of Short Trips for the Top 5 Counties", subtitle = "Frequency and Trends of Trips Under 10 Miles in Florida's Most Active Counties")
```

There's a clear pattern of fluctuation in trip volumes across all counties, with notable peaks and troughs indicating variability in travel behavior. Miami-Dade County consistently shows higher trip counts, suggesting it's the busiest for short trips (as identified previously), while the other counties exhibit more moderate numbers with their own distinct patterns.

-   **Medium Trips**

```{r}
trip_data_ts |> filter(County.Name %in% top_5_counties) |> autoplot(Number.of.Trips.50.100) + labs(y = "Number of Short Trips", title = "Distribution of Medium Trips for the Top 5 Counties", subtitle = "Analyzing the Patterns of Trips Between 50 to 100 Miles in Major Florida Counties")
```

The plot illustrates the distribution of medium trips (50 to 100 miles) for the top 5 counties in Florida, showcasing a more varied pattern compared to short trips. There's greater fluctuation and less consistency in the volume of medium trips, reflecting less frequent but more variable travel behaviors, such as occasional business or leisure trips. Unlike the steadier trend seen in short trips, medium trips exhibit higher peaks and more pronounced variability, possibly due to the less routine nature of such travel distances.

-   **Long Trips**

```{r}
trip_data_ts |> filter(County.Name %in% top_5_counties) |> autoplot(Number.of.Trips.250.500) + labs(y = "Number of Short Trips", title = "Distribution of Long Trips for the Top 5 Counties", subtitle = "Insights into Longer Journey Patterns Over 250 Miles in Florida's Busiest Counties")
```

The plot for long trips illustrates significantly lower frequencies compared to short and medium trips within the top 5 Florida counties, indicating that such distances are less commonly traveled on a daily basis. The sporadic peaks suggest that long trips are more likely to be influenced by non-routine events or seasonal travel. Unlike the consistent patterns seen with short trips and the moderate variability of medium trips, long trips display occasional surges that could align with holiday seasons or major events.

#### NOTE - From this Point and Onwards:

## Time Series #1 - Short Trips

While our preliminary data visualization encompassed the top five counties, we are now refining our focus for the in-depth analysis. Given the **univariate** scope of this project, our focus will narrow to **Miami-Dade County**, which records the highest number of trips. We will delve into the trends and patterns within the time series of short, medium, and long trips specific to this county.

By zeroing in on a single county, we can extract detailed insights into travel patterns, eliminating potential **noise** that could arise from data aggregated across **multiple regions**.

```{r}
# Filter the dataset for Miami-Dade County
miami_dade = trip_data_ts |> filter(County.Name == "Miami-Dade County")

# Focusing on short trips
miami_dade_short_trips = miami_dade |> select(Date, Number.of.Trips.5.10)|> as_tsibble(index = Date)

# Autoplot for trends and seasonality
autoplot(miami_dade_short_trips, Number.of.Trips.5.10) + labs(y = "Number of Trips", title = "Distribution of Short Trips in the County of Miami-Dade", subtitle = "Analyzing Trend and Seasonality")
```

-   **Trend**: The data does not show a strong long-term upward or downward trend; instead, the number of short trips appears to fluctuate around a consistent level across the years. There is no clear indication of a persistent increase or decrease in the volume of short trips over the entire time period.

    -   The dips observed in the years 2020 and 2022 within the Miami-Dade County short trips data are consistent with the impact of COVID-19 and its subsequent waves or public response measures. These periods likely reflect lockdowns, travel restrictions, or increased public caution, leading to a temporary decrease in short-distance travel.

-   **Seasonality**: The plot suggests a potential seasonality with regular patterns of peaks and troughs throughout the years. These could correspond to seasonal events, holidays, or weather patterns that affect travel behavior. The seasonality appears to be annual, with certain times of the year consistently experiencing higher or lower numbers of trips.

Let's view the seasonality with `gg_season()`:

-   **Yearly Seasonality**

```{r}
# Year 
miami_dade_short_trips |> gg_season(Number.of.Trips.5.10) + labs(y = "Number of Short Trips", title = "Period analysis of short trips on a yearly basis.")
```

Clear seasonal patterns are evident, with peaks likely indicating popular travel times such as holidays or events, and troughs potentially reflecting off-peak periods. The year 2020 shows a pronounced dip, consistent with the impact of COVID-19 restrictions on travel. There is a recovery in 2021, with trip volumes returning closer to pre-pandemic levels.

-   **Monthly Seasonality**

```{r}
# Month
miami_dade_short_trips |> gg_season(Number.of.Trips.5.10, period = "month") + labs(y = "Number of Short Trips", title = "Period analysis of short trips on a monthly basis.")
```

The overlapping lines indicate that seasonality is complex, with high variability, but certain months consistently reach higher peaks, suggesting more active travel periods which could be influenced by factors such as holidays, local events, or tourism trends. Some months show dips in activity, potentially corresponding to seasons with less favorable weather or post-holiday slowdowns.

The distinct color for each month aids in visual separation, but the precise interpretation of seasonality would benefit from a clearer visualization or statistical analysis to disentangle the overlapping lines.

-   **Weekly Seasonality**

```{r}
# Week
miami_dade_short_trips |> gg_season(Number.of.Trips.5.10, period = "week") + labs(y = "Number of Short Trips", title = "Period analysis of short trips on a weekly basis.")
```

-   There is significant week-to-week variability within each year, with certain weeks experiencing higher travel volumes, which could be related to local events, holidays, or other seasonal factors.

-   The overall patterns across different years are somewhat consistent, indicating a repeatable weekly rhythm to short trip travel, although the specific peaks and troughs vary from year to year.

-   Weekends (especially Friday) appear to generally have higher trip counts compared to weekdays, reflecting typical leisure and errand-running activities that occur when most people are not working.

-   There are noticeable dips in trip volume on specific weeks, which may correspond to major holidays or events when people are less likely to engage in routine travel.

-   **STL Decomposition**

To confirm these observations, further analysis with STL decomposition is necessary to separate the time series data into clear trend and seasonal components. This will provide a more precise understanding of the underlying patterns in the data.

```{r}
# STL for a detailed view
miami_dade_short_decomposed = miami_dade_short_trips |> model(stl = STL(Number.of.Trips.5.10 ~ season(window = "periodic")))

components(miami_dade_short_decomposed) |> autoplot() + labs(title = "STL Decompostion of Short Trips")
```

Insights that we can gather from the plot include:

-   **Trend**: The trend component shows a relatively stable level of short trips from the start of 2019 to early 2020, followed by a sharp decline likely due to the onset of the COVID-19 pandemic. After this initial drop, there's a gradual recovery, with trip levels returning to pre-pandemic conditions by late 2021 and remaining stable thereafter. There is no clear long-term increase or decrease in trip levels, indicating that the trend is relatively flat with some fluctuation due to external factors such as the pandemic.

-   **Seasonal Yearly**: The seasonal yearly component indicates a repeating annual pattern, with certain times of the year consistently experiencing higher or lower numbers of trips. This could be due to factors like holidays, tourist seasons, or weather patterns. The seasonality seems regular, suggesting predictable fluctuations throughout the year.

-   **Seasonal Weekly**: The seasonal weekly component shows a strong weekly pattern with regular fluctuations. This likely reflects the typical weekly cycle of human activity, with certain days (weekends) being more popular for short trips than others (like mid-week days).

-   **Remainder**: The remainder (or residual) component exhibits the noise after accounting for the trend and seasonal components. Any spikes or unusual patterns here could indicate irregular or one-off events that aren't captured by the trend or seasonal components.

```{r}
miami_dade_short_trips |> autoplot(Number.of.Trips.5.10, color = "black") + 
  autolayer(components(miami_dade_short_decomposed), trend, color = "orange", size = 0.75) + 
  labs(y = "Number of Short Trips", title = "Trend on Distribution of Number of Short Trips", subtitle = "County: Miami Dade // Dates from 01-01-2019 to 31-12-2023.")
```

We can further confirm the previous insights from the STL decomposition:

-   The overall trend line suggests that while there was a significant drop in short trips around early 2020, likely due to the COVID-19 pandemic, the trend gradually returned to pre-pandemic levels afterwards.

-   Post-2020, the trend remains relatively stable without a clear long-term increase or decrease, indicating a resilience or return to normalcy in travel patterns within the county after the initial pandemic shock.

-   The raw data shows a high level of **volatility** around the trend line, which is typical for daily travel data and may reflect daily fluctuations due to factors like weather, special events, or changes in weekday vs. weekend travel behavior.

```{r}
miami_dade_short_trips |> autoplot(Number.of.Trips.5.10, color = "black") + 
  autolayer(components(miami_dade_short_decomposed), season_adjust, color = "purple") + 
  labs(y = "Number of Short Trips", title = "Seasonal Adjustment on Distribution of Number of Short Trips", subtitle = "County: Miami Dade // Dates from 01-01-2019 to 31-12-2023.")
```

The original series likely exhibits fluctuations due to regular seasonal effects, such as weekly cycles or yearly patterns. The seasonally adjusted series aims to remove these seasonal variations to reveal the underlying trend and any irregular fluctuations in the data.

-   **Log Transformation**

```{r}
# Apply the log transformation
miami_dade_short_trips$Log_Short_Trips <- log(miami_dade_short_trips$Number.of.Trips.5.10 + 1)

miami_dade_short_trips <- miami_dade_short_trips %>%
  mutate(Log_Short_Trips = log(Number.of.Trips.5.10 + 1))

# Perform STL decomposition on the log-transformed data
stl_short_log <- miami_dade_short_trips %>%
  model(STL(Log_Short_Trips ~ season(window = "periodic")))

# Plot the components
components(stl_short_log) %>%
  autoplot() + labs(title = "STL Decomposition of Log-Transformed Short Trips")
```

The weekly seasonality in the log-transformed STL decomposition plot shows more consistent and regular oscillations compared to the non-transformed data, which indicates that the log transformation has likely stabilized the variance of the data over time.

The log transformation might hint at a potential shift in the weekly seasonality, specifically. Furthermore, the transformation seems to reduce the influence of outliers, as the variance appears more uniform across the entire time series.

-   **Box-Cox Transformation**

```{r}
library(forecast)

# First, we find the optimal lambda for the Box-Cox transformation
lambda_bc <- BoxCox.lambda(miami_dade_short_trips$Number.of.Trips.5.10)

# Apply the Box-Cox transformation with the calculated lambda
miami_dade_short_trips <- miami_dade_short_trips %>%
  mutate(Number.of.Trips.5.10.BoxCox = BoxCox(Number.of.Trips.5.10, lambda_bc))

# Perform STL decomposition on the Box-Cox transformed data
stl_short_bc <- miami_dade_short_trips %>%
  model(STL(Number.of.Trips.5.10.BoxCox ~ season(window = "periodic")))

# Plot the components of the STL decomposition
components(stl_short_bc) %>%
  autoplot() + labs(title = "STL Decomposition of Box-Cox Transformed Short Trips")
```

The Box-Cox transformation has yielded minimal enhancements to the trend line. Consequently, we will opt for the log transformation, which provides a more desirable outcome.

-   **Lag Analysis**

```{r}
miami_dade_short_trips |> gg_lag(Log_Short_Trips, geom = "point")
```

There is some slight seasonality evident in the plot, as the number of trades appears to be higher on Thursdays, Fridays, and Saturdays. However, the autocorrelation does not appear to be very strong for any of the lags, which suggests that there is not a very strong relationship between the number of trades on a given day and the number of trades on previous days. But overall, it seems like there is not a lot of variability in terms of seasonality.

### Statistical Analysis

-   **ACF**

```{r}
acf(miami_dade_short_trips$Log_Short_Trips, lag.max = 28, main = "ACF for Log Short Trips")
```

The ACF plot for `Log Short Trips` indicates a strong autocorrelation at lag 0, as expected, since this is the correlation of the series with itself. The consistent spikes at every 7th lag suggest a weekly seasonality in the data, with these regular peaks indicating that the number of short trips has a strong weekly pattern. The autocorrelation remains within the confidence bounds, implying the seasonal effect is significant at these lags.

-   **PACF**

```{r}
pacf(miami_dade_short_trips$Log_Short_Trips, lag.max = 28, main = "PACF for Log Short Trips")
```

The PACF plot for `Log Short Trips` exhibits significant partial autocorrelation at lag 1, indicating a potential **AR(1)** component. The subsequent lags are not significantly different from zero until we see spikes at intervals of approximately 7 lags, which reinforces the suggestion of weekly seasonality in the data. However, the pattern is not as pronounced as in the ACF plot, which is typical as the PACF plot shows the correlation of a time series with its own lagged values, discounting the contributions from the intermediate lags. This information will be useful for specifying AR terms in seasonal ARIMA models.

### Model Selection

-   **Visual Interpretation of ACF and PACF: AR(1) with Season (7)**

```{r}
# Fit an AR(1) model with a seasonal period of 7
arima_fit <- Arima(miami_dade_short_trips$Log_Short_Trips, order = c(1, 0, 0), seasonal = list(order = c(1, 0, 0), period = 7))

# Print the model
print(arima_fit)
```

Let's compare it to the auto model.

```{r}
# Fit a SARIMA model
sarima_fit <- auto.arima(miami_dade_short_trips$Log_Short_Trips, seasonal = TRUE)

# Check model residuals
print(sarima_fit)
```

We can see that our model performs better than the auto according to the above metrics.

Let's check the residuals:\

```{r}
# Check model residuals
checkresiduals(arima_fit)
```

-   **Residuals Over Time**: The residuals appear to be centered around zero without any clear pattern, which is a good sign that the model is capturing the underlying process well.

-   **ACF of Residuals**: There are no significant spikes in the ACF plot outside the confidence bounds, indicating that there is no autocorrelation in the residuals. This suggests that the model has adequately captured the time series' dependence structure.

-   **Histogram of Residuals**: The residuals closely follow a normal distribution, as indicated by the overlaying red line which represents a normal distribution fit. This is a desirable property and suggests that the residuals are random.

The Ljung-Box test results with a p-value \< 2.2e-16 indicate that there is very strong evidence against the null hypothesis of no autocorrelation in the residuals, which could imply that the model may not be adequately capturing all the autocorrelation in the data or there may be some leftover seasonality. This could lead to reconsidering the model fit, potentially including additional lags or seasonal terms.

```{r}
# Check model residuals
checkresiduals(sarima_fit)
```

-   **Ljung-Box test:** While the p-value is still **less than 2.2e-16**, it's **higher** than the AR(1) model's p-value, suggesting **weaker evidence** against no autocorrelation.

-   The residual plot shows a **scattered pattern** around zero, with **no clear trends or large spikes**. This is an improvement compared to the AR(1) model's residuals, which exhibited a curving trend and large spikes.

```{r}
# Filter the data up until 2022-12-31 (80:20 split) (4 years of training and 1 of test)

train = miami_dade_short_trips |> filter_index(~"2022-12-31")

# Compute the autocorrelation function and plot it
acf(train$Log_Short_Trips, lag.max = 28) |> autoplot()
pacf(train$Log_Short_Trips, lag.max = 28) |> autoplot()
```

-   The ACF plot shows strong autocorrelation at lag 1 and subsequent lags that are multiples of 7, which decay gradually but stay within the significance bounds. This indicates a significant autocorrelation at the first lag and a repeating pattern that suggests weekly seasonality.

-   The PACF plot displays a significant spike at lag 1, which falls off sharply afterwards. This is a classic indicator of an AR(1) process, where the first lag is a good predictor for the next value in the series, and the effect of further lags is minimal.

-   The consistent spikes at every 7th lag in the ACF plot and not in the PACF plot point to a seasonal pattern that is best captured by a seasonal AR component rather than being part of the non-seasonal AR process.

Let's train multiple models and see how they perform:

```{r}
miami_dade_short_trips_fit <- train %>%
  model(
    mean = MEAN(Log_Short_Trips),
    naive = NAIVE(Log_Short_Trips),
    snaive = SNAIVE(Log_Short_Trips),
    ets = ETS(Log_Short_Trips),
    AR.sAR = ARIMA(Log_Short_Trips ~ pdq(1,0,0) + PDQ(1,0,0) + season(365)),
    auto = ARIMA(Log_Short_Trips, stepwise = FALSE, approximation = FALSE) 
  ) %>%
  mutate(ensemble = (ets + snaive + auto) / 3)
```

Let's evaluate the accuracy of the models we have obtained:

```{r}
accuracy(miami_dade_short_trips_fit)
```

Based on these metrics, the **`auto`** model has the lowest RMSE, MAE, and is among the lowest in the other metrics, while also maintaining a low ACF1 close to 0. This suggests the **`auto`** model has a good balance of accurately capturing the data's pattern without overfitting.

The **`ets`** model also performs well, particularly on MASE and RMSSE, suggesting it performs well in comparison to a naive model, but the **`auto`** model has a slightly better RMSE and MAE.

While the `AR.sAR` model does not outperform the `auto` model in terms of RMSE and MAE, it is competitive and can be considered a good fit depending on this context and use case.

### Prediction Intervals

```{r}
# Defining our test set
test = miami_dade_short_trips |> filter_index("2023-01-01" ~ "2023-01-07")

# Generate forecasts with 95% prediction intervals
miami_dade_short_trips_fc <- miami_dade_short_trips_fit %>% 
  forecast(h = length(test$Log_Short_Trips), level = 95)

# Plot the forecasts along with the 95% prediction intervals
autoplot(miami_dade_short_trips_fc) +
  labs(y = "Log Short Trips", title = "Forecasts for daily short trips in Miami-Dade County") +
  guides(colour = guide_legend(title = "Forecast")) +
  geom_line(data = test, aes(x = Date, y = Log_Short_Trips), color = "red") +
  autolayer(test, Log_Short_Trips, colour = "black", linewidth = 0.8)
```

Key observations:

-   The **`auto`** model (automatic ARIMA) appears to provide the most confident forecast with the narrowest prediction intervals, which suggests that it has the lowest uncertainty associated with its forecasts.

-   The **`AR.sAR`** model, which includes both autoregressive terms and seasonal autoregressive terms, shows slightly wider prediction intervals than the **`auto`** model, indicating a bit more uncertainty but still performing well.

-   The **`ets`** model also performs competently with prediction intervals comparable to those of the **`AR.sAR`** model, implying similar confidence levels in its forecasts.

-   The **`ensemble`** model, which averages the forecasts from the **`ets`**, **`snaive`**, and **`auto`** models, has prediction intervals that are broader than the best individual models, suggesting that combining these models doesn't necessarily provide a more accurate forecast.

-   The **`naive`** and **`snaive`** models have the widest prediction intervals, indicating a higher level of uncertainty in their forecasts.

## Time Series #2 - Medium Trips

Let's now move onto our second time series which corresponds to the medium trips which cover distances between 50 and 100 miles.

```{r}
# Filter the dataset for Miami-Dade County
miami_dade = trip_data_ts |> filter(County.Name == "Miami-Dade County")

# Focusing on medium trips
miami_dade_medium_trips = miami_dade |> select(Date, Number.of.Trips.50.100)|> as_tsibble(index = Date)

# Autoplot for trends and seasonality
autoplot(miami_dade_medium_trips, Number.of.Trips.50.100) + labs(y = "Number of Trips", title = "Distribution of Medium Trips in the County of Miami-Dade", subtitle = "Analyzing Trend and Seasonality")
```

-   There is a notable downward trend in the number of trips starting from the beginning of 2020, which could correlate with the onset of the COVID-19 pandemic and its associated restrictions on movement.

-   Following the initial decline, there is a recovery phase with the number of trips increasing again, suggesting a return to pre-pandemic patterns or an adaptation to new travel habits.

-   The data displays periodic fluctuations, indicating potential weekly or monthly seasonality. These could reflect regular patterns of activity, such as increased travel during weekends or specific days of the week.

```{r}
# Year 
miami_dade_medium_trips |> gg_season(Number.of.Trips.50.100) + labs(y = "Number of Medium Trips", title = "Period analysis of medium trips on a yearly basis.")
```

-   Seasonal patterns are present, with noticeable fluctuations throughout the years, indicating times of increased and decreased medium-distance travel.

-   The year 2020 stands out with a significant reduction in travel, aligning with the global impact of COVID-19 and suggesting substantial disruption to typical travel behaviors.

-   Subsequent years, particularly 2021, exhibit a rebound in travel activity, suggesting an adjustment or recovery towards more regular travel patterns post-pandemic.

-   Unlike short trips, the medium trip volumes don't return entirely to pre-pandemic levels, which might suggest a longer-lasting impact of the pandemic on medium-distance travel habits or preferences.

-   Annual peaks and troughs can likely be attributed to seasonal travel behaviors, possibly influenced by factors such as holidays, school breaks, and local events. The peaks appear to be less pronounced in 2020, possibly due to travel restrictions.

```{r}
# Month
miami_dade_medium_trips |> gg_season(Number.of.Trips.50.100, period = "month") + labs(y = "Number of Medium Trips", title = "Period analysis of medium trips on a monthly basis.")
```

-   There's a visible monthly seasonality, with peaks and troughs that suggest a repeating pattern across each year. This indicates that certain months consistently have higher or lower numbers of trips.

-   The variability from month to month appears substantial, with some months, like those represented by the peaks in 2023 Feb and 2023 Dec, showing high travel activity which could align with seasonal events or holidays.

-   Months like 2020 Aug show lower levels of medium trips, possibly as a result of the pandemic or seasonal patterns where travelers may opt for shorter trips or none at all.

-   The dense overlap of lines makes it challenging to discern clear trends for individual months. However, it seems that travel behavior is somewhat consistent within the same months across different years, barring anomalies such as those caused by the COVID-19 pandemic in 2020.

-   To better understand the monthly seasonality and its causes, additional analysis or a more distinct visualization technique would be helpful to separate the effects of each month more clearly.

```{r}
# Week
miami_dade_medium_trips |> gg_season(Number.of.Trips.50.100, period = "week") + labs(y = "Number of Medium Trips", title = "Period analysis of medium trips on a weekly basis.")
```

-   The graph shows notable fluctuation in the number of medium trips taken weekly, with certain weeks seeing spikes in travel activity, possibly due to events or local holidays.

-   While the pattern varies year to year, some consistent trends suggest a regular weekly cycle of travel behavior. This could reflect routine weekly activities such as mid-week errands or weekend outings.

-   Days like Friday and Saturday often show increased travel, which might be attributed to the start of the weekend when people engage in leisure activities or travel for short breaks.

-   Conversely, certain weeks display significant drops in travel, potentially aligning with major holidays or events when regular travel is disrupted.

```{r}
# STL for a detailed view
miami_dade_medium_decomposed = miami_dade_medium_trips |> model(stl = STL(Number.of.Trips.50.100 ~ season(window = "periodic")))

components(miami_dade_medium_decomposed) |> autoplot() + labs(title = "STL Decompostion of Medium Trips")
```

-   **Trend Component**: The trend for medium trips shows more pronounced variability compared to short trips, with noticeable fluctuations over the entire period. There is a significant drop around early 2020, which aligns with the COVID-19 pandemic impact seen in short trips, followed by a recovery phase that exhibits more volatility. This could imply that medium trip patterns are more sensitive to external factors and take longer to stabilize after disruptions.

-   **Seasonal Yearly Component**: The yearly seasonality shows distinct patterns, with peaks and troughs that recur on an annual basis. This component captures the broader, predictable seasonal shifts that may be influenced by factors such as school holidays, vacation seasons, or annual events that affect travel behavior.

-   **Seasonal Weekly Component**: The weekly seasonality indicates a regular weekly cycle, with potential peaks corresponding to weekends or particular days of the week when medium trips are more frequent. This is consistent with routine human activities that vary by day of the week.

-   **Remainder Component**: The remainder of the series, after accounting for the trend and seasonal components, displays the irregular or unexplained noise. For medium trips, this might include unexpected events or anomalies not captured by the model. The presence of these unexplained fluctuations could suggest that medium trips are influenced by a wider array of non-seasonal factors compared to short trips.

```{r}
miami_dade_medium_trips |> autoplot(Number.of.Trips.50.100, color = "black") + 
  autolayer(components(miami_dade_medium_decomposed), trend, color = "orange", size = 0.75) + 
  labs(y = "Number of Medium Trips", title = "Trend on Distribution of Number of Medium Trips", subtitle = "County: Miami Dade // Dates from 01-01-2019 to 31-12-2023.")
```

-   The trend line indicates an overall increasing tendency in the number of medium trips over the five-year period, suggesting a growing preference or need for trips of this distance range.

-   There's a noticeable dip in the number of trips around the early to mid-2020 period, consistent with the impact of the COVID-19 pandemic on travel behavior. However, following this period, there is a recovery, with the number of medium trips climbing back up.

-   The raw data demonstrates significant variability around the trend line, with numerous spikes and troughs. This variability could be attributed to daily or weekly fluctuations in travel, potentially influenced by factors like weather conditions, local events, or seasonal travel trends.

-   The high volatility of the data points also suggests that while there is an overall trend, individual values can vary greatly from day to day, underlining the dynamic nature of medium trip travel patterns.

```{r}
miami_dade_medium_trips |> autoplot(Number.of.Trips.50.100, color = "black") + 
  autolayer(components(miami_dade_medium_decomposed), season_adjust, color = "purple") + 
  labs(y = "Number of Medium Trips", title = "Seasonal Adjustment on Distribution of Number of Medium Trips", subtitle = "County: Miami Dade // Dates from 01-01-2019 to 31-12-2023.")
```

-   The seasonally adjusted series (purple) appears to smooth out the regular fluctuations seen in the original data (black), providing a clearer view of the underlying trends without the influence of seasonal patterns.

-   After the seasonal adjustment, the significant dip in trip volume around 2020 becomes even more pronounced, emphasizing the impact of the COVID-19 pandemic on travel behavior.

-   The seasonally adjusted data reveals a gradual recovery post-2020, similar to the trend observed in the non-adjusted data, supporting the idea of a return to normalcy or an adaptation to new travel behaviors following the initial pandemic impact.

-   The seasonally adjusted trend line helps in identifying the true shifts in travel demand over time, as it removes the regular seasonal highs and lows that could potentially obscure such trends.

```{r}
# Apply the log transformation
miami_dade_medium_trips$Log_Medium_Trips <- log(miami_dade_medium_trips$Number.of.Trips.50.100 + 1)

miami_dade_medium_trips <- miami_dade_medium_trips %>%
  mutate(Log_Medium_Trips = log(Number.of.Trips.50.100 + 1))

# Perform STL decomposition on the log-transformed data
stl_medium_log <- miami_dade_medium_trips %>%
  model(STL(Log_Medium_Trips ~ season(window = "periodic")))

# Plot the components
components(stl_medium_log) %>%
  autoplot() + labs(title = "STL Decomposition of Log-Transformed Medium Trips")
```

-   **Trend Component**: The trend for log-transformed medium trips continues to show a significant drop around early 2020, consistent with the impact of the COVID-19 pandemic. There's an observable recovery, but the trend remains relatively flat afterward, with slight undulations indicating some instability or minor long-term fluctuations in medium trip levels.

-   **Seasonal Yearly Component**: The yearly seasonal component is more pronounced in the log-transformed data, with clear, regular peaks and troughs. This transformation may have highlighted the true underlying seasonal effects by stabilizing the variance, allowing for a clearer pattern to emerge on an annual basis.

-   **Seasonal Weekly Component**: The weekly seasonality shows distinct peaks and troughs corresponding to specific days of the week, which suggests a consistent weekly travel pattern. The log transformation seems to have equalized the scale of these fluctuations, making them more interpretable and possibly revealing subtler weekly patterns that were previously overshadowed by the variance in the raw data.

-   **Remainder Component**: The remainder of the series, which represents the noise or unexplained variation after accounting for the trend and seasonality, appears less volatile in the log-transformed data. This indicates that the log transformation has successfully moderated extreme values, leading to a more homoscedastic series---where the variance of the residuals is more constant over time.

### Statistical Analysis of Medium Trips

```{r}
acf(miami_dade_medium_trips$Log_Medium_Trips, lag.max = 28, main = "ACF for Medium Trips")
```

-   **Strong Initial Autocorrelation**: As with most ACF plots, there's a strong autocorrelation at lag 0, which is the series correlated with itself.

-   **Significant Weekly Seasonality**: There are clear and consistent spikes at lags that are multiples of 7 (e.g., lags 7, 14, 21), which indicates a strong weekly pattern in the medium trips data. This suggests that the behavior of medium trips is influenced by the day of the week, with a regular and predictable pattern.

-   **Decaying Correlation**: The spikes in autocorrelation seem to decrease in magnitude as the lags increase, which is typical in ACF plots and indicates that the influence of past values diminishes over time.

-   **Within Confidence Bounds**: The autocorrelations, particularly for the weekly seasonal lags, are well above the confidence bounds, confirming that the observed seasonality is statistically significant and not due to random variation.

```{r}
pacf(miami_dade_medium_trips$Log_Medium_Trips, lag.max = 28, main = "PACF for Medium Trips")
```

-   The initial lag has a high partial autocorrelation, which is typical as it represents the direct correlation of the series with itself.

-   Unlike the ACF, the PACF does not show clear, consistent spikes at multiples of 7, which implies that the weekly seasonality observed in the ACF is not as pronounced when controlling for other lags. This can suggest that the weekly pattern is not the only driver of correlation in the data and that other factors may also be influencing the medium trip counts.

-   The partial autocorrelations for most lags fall within the confidence interval, which suggests that they are not significantly different from zero. This could mean that there are no strong relationships between medium trip counts at a given lag and those at previous lags when accounting for the values at all intervening lags.

-   The lack of significant spikes outside the confidence bounds suggests that individual past values do not have a strong linear predictive power on future values, beyond what is already explained by the intervening lags.

While there is a strong initial autocorrelation at lag 1, the presence of **significant spikes at other lags**, particularly **multiples of 7**, suggests that the data might be better suited for a model that can capture the **weekly seasonality** observed in the PACF. This could be an **ARIMA model** with a seasonal component, such as an ARIMA(p, d, q)(P, D, Q)s, where "s" represents the seasonality period (in this case, likely "7" for weekly).

### Model Selection

```{r}
# Fit an AR(1) model with a seasonal period of 7
arima_fit_med <- Arima(miami_dade_medium_trips$Log_Medium_Trips, order = c(1, 0, 0), seasonal = list(order = c(1, 0, 0), period = 7))

# Print the model
print(arima_fit_med)
```

Comparing the results to auto:

```{r}
# Fit a SARIMA model
sarima_fit_med <- auto.arima(miami_dade_medium_trips$Log_Medium_Trips, seasonal = TRUE)

# Check model residuals
print(sarima_fit_med)
```

Comparing the diagnosis we can see that:

```{r}
# Check model residuals
checkresiduals(arima_fit_med)
```

```{r}
checkresiduals(sarima_fit_med)
```

Comparing both models we can see that the Q\* statistic (which is a measure of the overall autocorrelation in the residuals) is much higher for the ARIMA(2,1,2) model (552.49) than for the ARIMA(1,0,0)(1,0,0)[7] model (161.36). This suggests that the ARIMA(2,1,2) model has more autocorrelation in its residuals, and therefore may be a worse fit to the data.

```{r}
# Filter the data up until 2022-12-31 (80:20 split) (4 years of training and 1 of test)

train = miami_dade_medium_trips |> filter_index(~"2022-12-31")

# Compute the ACF and PACF and plot it
acf(train$Log_Medium_Trips, lag.max = 28) |> autoplot()
pacf(train$Log_Medium_Trips, lag.max = 28) |> autoplot()
```

-   The ACF plot displays a gradual decay in the correlation values as the lags increase, which is typical for a time series with an autoregressive structure.

-   There are significant autocorrelations at the initial lags, with the first lag showing a particularly high value, suggesting an AR(1) component might be present.

-   The autocorrelations remain positive and outside the confidence bounds for several lags, indicating sustained influence from previous values.

-   The PACF plot shows a spike at the first lag that is above the confidence bounds, reinforcing the presence of an AR(1) component in the data.

-   After the initial spike, the PACF values fall within the confidence bounds, suggesting that there is no additional autoregressive effect beyond the first lag that is not already explained by the AR(1) component.

-   The PACF values are relatively low and oscillate around zero, which is expected after accounting for the autoregressive component in the data.

```{r}
miami_dade_medium_trips_fit <- train %>%
  model(
    mean = MEAN(Log_Medium_Trips),
    naive = NAIVE(Log_Medium_Trips),
    snaive = SNAIVE(Log_Medium_Trips),
    ets = ETS(Log_Medium_Trips),
    AR.sAR = ARIMA(Log_Medium_Trips ~ pdq(1,0,0) + PDQ(1,0,0) + season(7)),
    auto = ARIMA(Log_Medium_Trips, stepwise = FALSE, approximation = FALSE) 
  ) %>%
  mutate(ensemble = (ets + snaive + auto) / 3)
```

```{r}
accuracy(miami_dade_medium_trips_fit)
```

For **`Log_Medium_Trip`**:

-   The **`auto`** model has the lowest RMSE, MAE, and is second-lowest in MAPE, indicating it performs best in terms of forecast accuracy.

-   The **`AR.sAR`** model shows slightly higher RMSE and MAE values compared to **`auto`**, but still performs well and better than the other models.

-   The **`ets`** model is competitive, with the third-best RMSE and MAE, but has better MAPE than **`AR.sAR`**, indicating it is more accurate percentage-wise.

In comparison between **`Log_Short_Trip`** and **`Log_Medium_Trip`**, **`auto`** remains the best model for both, but it's worth noting that for **`Log_Medium_Trip`**, the **`auto`** model's performance metrics (RMSE, MAE, and MAPE) are slightly higher than for **`Log_Short_Trip`**, indicating a slightly less accurate forecast. The **`AR.sAR`** and **`ets`** models also show similar patterns in performance between the two trip types.

It's also worth considering the ACF1 values, which measure the first-lag autocorrelation of the residuals. Ideally, this should be close to zero, indicating that the residuals are random. In this case, the **`auto`** model shows an ACF1 close to zero for **`Log_Medium_Trip`**, which is desirable.

### Prediction Intervals

```{r}
# Defining our test set
test = miami_dade_medium_trips |> filter_index("2023-01-01" ~ "2023-01-07")

# Generate forecasts with 95% prediction intervals
miami_dade_medium_trips_fc <- miami_dade_medium_trips_fit %>%
  forecast(h = length(test$Log_Medium_Trips), level = 95)

# Plot the forecasts along with the 95% prediction intervals
autoplot(miami_dade_medium_trips_fc) +
  labs(y = "Log Medium Trips", title = "Forecasts for daily medium trips in Miami-Dade County") +
  guides(colour = guide_legend(title = "Forecast")) +
  geom_line(data = test, aes(x = Date, y = Log_Medium_Trips), color = "red") +
  autolayer(test, Log_Medium_Trips, colour = "black", linewidth = 0.8)
```

1.  **Model Lines**: The central lines for the `AR.sAR`, `auto`, and `ets` models are close to each other, indicating that their point forecasts are similar. This suggests that these models have a consensus on the expected level of medium trips.

2.  **Prediction Intervals**: The width of the prediction intervals gives us an indication of the uncertainty associated with the forecasts. Smaller intervals imply more confidence in the predictions. In this plot, it appears that the auto model has narrower intervals than the `AR.sAR` and `ets`, particularly at the 95% confidence level, which would align with its performance being the best among the three according to the earlier accuracy metrics.

3.  **Comparative Analysis**: When compared to the short trips forecast, if the intervals for the medium trips are similarly narrow and the actual observed data (not shown in the plot) falls within these intervals, this would confirm the robustness of the auto model across different trip lengths. However, if the medium trip intervals are wider or the actuals don\'t align as well, this could suggest different underlying dynamics between short and medium trip behaviors, possibly requiring model adjustments or alternative approaches for medium trips.

4.  **Best Model Selection**: Given that the auto model had the lowest RMSE and MAE in the accuracy metrics, and assuming its prediction intervals are indeed the narrowest, it would be considered the best performing model. It appears to provide a good balance between fitting the historical data and offering precise forecasts for future data.

## Time Series #3 - Long Trips

Let's now move onto our second time series which corresponds to the long trips which cover distances between 250 and 500 miles.

```{r}
# Filter the dataset for Miami-Dade County
miami_dade = trip_data_ts |> filter(County.Name == "Miami-Dade County")

# Focusing on long trips
miami_dade_long_trips = miami_dade |> select(Date, Number.of.Trips.250.500)|> as_tsibble(index = Date)

# Autoplot for trends and seasonality
autoplot(miami_dade_long_trips, Number.of.Trips.250.500) + labs(y = "Number of Trips", title = "Distribution of Long Trips in the County of Miami-Dade", subtitle = "Analyzing Trend and Seasonality")
```

**1. COVID-19 impact:** Similar to medium trips, long trips show a **significant decline** starting in **early 2020**, likely due to the COVID-19 pandemic and related travel restrictions.

**2. Slower recovery:** While the number of long trips has **increased** since the initial drop, it appears to be **recovering at a slower pace** compared to medium trips. This might suggest a longer-lasting impact of the pandemic on long-distance travel habits.

**3. Potential seasonality:** The plot hints at **periodic fluctuations**, suggesting potential **seasonal patterns** in long trips. However, these fluctuations appear **less pronounced** compared to medium trips, possibly indicating weaker seasonal effects on long-distance travel behavior.

```{r}
# Year 
miami_dade_long_trips |> gg_season(Number.of.Trips.250.500) + labs(y = "Number of Long Trips", title = "Period analysis of long trips on a yearly basis.")
```

-   **Seasonal patterns:** Similar to medium trips, long trips show **seasonal fluctuations** throughout the years, with potential peaks around holidays or specific events.

-   **Impact of COVID-19:** There's a **significant drop** in long trips in **2020**, coinciding with the global pandemic, suggesting disruptions in travel behavior.

-   **Slower recovery:** Unlike medium trips, long trips haven't fully recovered to pre-pandemic levels by 2023, potentially indicating a longer-lasting impact on travel habits or preferences.

```{r}
# Month
miami_dade_long_trips |> gg_season(Number.of.Trips.250.500, period = "month") + labs(y = "Number of Long Trips", title = "Period analysis of long trips on a monthly basis.")
```

-   **Recurring patterns:** Consistent peaks and troughs across years suggest **repeating monthly patterns**, with specific months experiencing **higher or lower** travel activity.

-   **Variability and potential reasons:** The substantial variation month-to-month might be due to factors like:

    -   **Seasonal events or holidays:** Peaks in February and December 2023 could be associated with winter holidays.

    -   **COVID-19 impact:** The lower volume in August 2020 might reflect pandemic-related travel restrictions.

    -   **General seasonal trends:** Travelers might opt for shorter trips or no travel during certain months.

-   **Limited individual month trends:** The overlapping lines make it difficult to discern clear trends for each month, but travel behavior seems **somewhat consistent** within the same months across different years, excluding anomalies like the pandemic in 2020.

```{r}
# Week
miami_dade_long_trips |> gg_season(Number.of.Trips.250.500, period = "week") + labs(y = "Number of Long Trips", title = "Period analysis of long trips on a weekly basis.")
```

**Weekly seasonality:** Similar to medium trips, long trips also exhibit **weekly seasonality**, with **increased activity on weekends** (likely Fridays and Saturdays) and potentially **lower activity during weekdays**. This suggests that weekend leisure activities or short breaks might influence long-trip patterns.

**Yearly variations:** The color intensity across different weeks within a year seems to vary, indicating **fluctuations throughout the year**. This might be due to factors like:

-   **Seasonal events or holidays:** Certain weeks might see higher travel activity due to holidays or seasonal events that encourage long trips.

-   **School breaks:** Periods like summer breaks could also influence travel patterns, potentially leading to increased long trips during those times.

```{r}
# STL for a detailed view
miami_dade_long_decomposed = miami_dade_long_trips |> model(stl = STL(Number.of.Trips.250.500 ~ season(window = "periodic")))

components(miami_dade_long_decomposed) |> autoplot() + labs(title = "STL Decompostion of Long Trips")
```

**Trend:** Similar to medium trips, the **trend** for long trips shows a **downward turn in early 2020**, likely due to the COVID-19 pandemic. However, the **recovery for long trips appears slower** and **more volatile** compared to medium trips, suggesting long-distance travel might be more sensitive to disruptions and take longer to recover.

**Seasonality:** Both **yearly** and **weekly seasonality** are present in long trips, similar to medium trips. Yearly seasonality likely reflects recurring patterns influenced by holidays, vacations, or annual events. Weekly seasonality suggests **higher travel activity on weekends**, potentially due to leisure activities or short breaks.

**Remainder:** The **remainder** component for long trips appears similar to medium trips, indicating the presence of **unexplained fluctuations** not captured by the trend and seasonal components. This suggests that long trips, like medium trips, are influenced by various non-seasonal factors beyond the captured trends and seasonality.

```{r}
miami_dade_long_trips |> autoplot(Number.of.Trips.250.500, color = "black") + 
  autolayer(components(miami_dade_long_decomposed), trend, color = "orange", size = 0.75) + 
  labs(y = "Number of Long Trips", title = "Trend on Distribution of Number of Long Trips", subtitle = "County: Miami Dade // Dates from 01-01-2019 to 31-12-2023.")
```

**Trend:** The **trend component** shows an **overall increasing tendency** in the number of short trips over the five-year period. This suggests a growing preference or need for short trips.

**Seasonality:** The **seasonal component** captures recurring seasonal patterns, such as **weekly cycles or yearly variations**, that influence the number of short trips.

**Remainder:** The **remainder component** represents the **residual fluctuations** in the data that are not captured by the trend and seasonal components. These fluctuations could be due to various factors like:

-   **Daily or weekly variations:** Weather conditions, local events, or short-term travel trends.

-   **Random noise:** Inherent variability in human behavior and travel patterns.

```{r}
miami_dade_long_trips |> autoplot(Number.of.Trips.250.500, color = "black") + 
  autolayer(components(miami_dade_long_decomposed), season_adjust, color = "purple") + 
  labs(y = "Number of Long Trips", title = "Seasonal Adjustment on Distribution of Number of Long Trips", subtitle = "County: Miami Dade // Dates from 01-01-2019 to 31-12-2023.")
```

1.  **Smoothing of seasonal fluctuations:** The seasonally adjusted series (purple) removes the regular ups and downs seen in the original data (black), revealing the underlying trend.

2.  **Emphasis on COVID-19 impact:** The seasonal adjustment makes the sharp decline in trips around 2020 (likely due to the pandemic) even more evident.

3.  **Gradual recovery:** The adjusted data suggests a gradual increase in long trips after 2020, similar to the unadjusted data, indicating a potential recovery or adaptation to new travel patterns.

4.  **Clarity of trends:** The removal of seasonal variations helps identify the true changes in travel demand over time.

```{r}
# Apply the log transformation
miami_dade_long_trips$Log_Long_Trips <- log(miami_dade_long_trips$Number.of.Trips.250.500 + 1)

miami_dade_long_trips <- miami_dade_long_trips %>%
  mutate(Log_Long_Trips = log(Number.of.Trips.250.500 + 1))

# Perform STL decomposition on the log-transformed data
stl_long_log <- miami_dade_long_trips %>%
  model(STL(Log_Long_Trips ~ season(window = "periodic")))

# Plot the components
components(stl_medium_log) %>%
  autoplot() + labs(title = "STL Decomposition of Log-Transformed Long Trips")
```

-   **Trend:** Similar to medium trips, the **log-transformed trend** shows a **decline in early 2020** (likely due to COVID-19) followed by a **slow recovery** with **minor long-term variations**.

-   **Yearly seasonality:** The log transformation **accentuates the yearly seasonal patterns**, making the peaks and troughs more prominent.

-   **Weekly seasonality:** Similar to medium trips, weekly seasonality is present, with **peaks potentially corresponding to weekends**. The log transformation might **reveal subtler weekly variations** by reducing the impact of extreme values.

-   **Remainder:** The **log transformation reduces the variability** in the remainder component, indicating it has successfully **moderated extreme values** in the data.

### Statistical Analysis of Long Trips

```{r}
acf(miami_dade_long_trips$Log_Long_Trips, lag.max = 28, main = "ACF for Long Trips")
```

The ACF plot for Long Trips displays a pattern of significant autocorrelation spikes at regular intervals, which decrease in a sinusoidal manner as the lags increase. This indicates a strong seasonal pattern, which in this case appears to be yearly given the consistent spacing between the spikes. The presence of such spikes suggests that the number of long trips is influenced by seasonal factors that recur at regular intervals throughout the time series.

```{r}
pacf(miami_dade_long_trips$Log_Long_Trips, lag.max = 28, main = "PACF for Long Trips")
```

The PACF plot for Long Trips shows that the autocorrelations at the first few lags are significant and then cut off, which is indicative of an AR(1) model. This means the first lag is significantly correlated with the current value after accounting for the intermediate lags. The sharp drop after lag 1 suggests that the value of a trip on a given day is primarily influenced by the value on the previous day, with little to no correlation with days further in the past. Given the pattern, an **AR(1)** model would likely be the best fit for this data

### Model Selection

```{r}
# Fit an AR(1) model with a seasonal period of 7
arima_fit_long <- Arima(miami_dade_long_trips$Log_Long_Trips, order = c(1, 0, 0), seasonal = list(order = c(1, 0, 0), period = 7))

# Print the model
print(arima_fit_long)
```

Once again the `AR(1)` does fit the data quite well.

```{r}
# Fit a SARIMA model
sarima_fit_long <- auto.arima(miami_dade_long_trips$Log_Long_Trips, seasonal = TRUE)

# Check model residuals
print(sarima_fit_long)
```

Let's compare the visual diagnosis:

```{r}
checkresiduals(arima_fit_long)
```

```{r}
checkresiduals(sarima_fit_long)
```

Once again, the Q\* statistic (which is a measure of the overall autocorrelation in the residuals) is much higher for the ARIMA(2,1,5) model (420.62) than for the ARIMA(1,0,0)(1,0,0)[7] model (171.28). This suggests that the ARIMA(2,1,5) model has more autocorrelation in its residuals, and therefore may be a worse fit to the data.

```{r}
# Filter the data up until 2022-12-31 (80:20 split) (4 years of training and 1 of test)

train = miami_dade_long_trips |> filter_index(~"2022-12-31")

# Compute the ACF and PACF and plot it
acf(train$Log_Long_Trips, lag.max = 28) |> autoplot()
pacf(train$Log_Long_Trips, lag.max = 28) |> autoplot()
```

1.  **ACF Plot**: The ACF shows strong autocorrelation at initial lags that slowly diminishes as the lags increase. This pattern suggests that there is a significant level of serial correlation in the long trips data. Unlike the short and medium trips, the ACF does not show clear spikes at seasonal lags, which could mean that the long trips do not have as pronounced a weekly seasonality, or the seasonality might be less regular.

2.  **PACF Plot**: The PACF shows a sharp drop after the first lag and then levels out, which is characteristic of an AR(1) process. The bars remain within the confidence interval for the majority of the lags, indicating that there are no additional significant autocorrelations once the effect of the first lag is accounted for.

When compared to the ACF and PACF for the **`Log_Short_Trips`** and **`Log_Medium_Trips`**:

-   The **`Log_Short_Trips`** and **`Log_Medium_Trips`** showed more evident periodic spikes in the ACF, especially at multiples of 7, indicating a weekly seasonality pattern that is not as clear in the long trips.

-   The PACF for **`Log_Short_Trips`** and **`Log_Medium_Trips`** also showed a more pronounced tailing off, which could suggest that those series might be better described by higher-order AR processes or models incorporating seasonal terms, which is less evident for the long trips.

```{r}
miami_dade_long_trips_fit <- train %>%
  model(
    mean = MEAN(Log_Long_Trips),
    naive = NAIVE(Log_Long_Trips),
    snaive = SNAIVE(Log_Long_Trips),
    ets = ETS(Log_Long_Trips),
    AR.sAR = ARIMA(Log_Long_Trips ~ pdq(1,0,0) + PDQ(1,0,0) + season(7)),
    auto = ARIMA(Log_Long_Trips, stepwise = FALSE, approximation = FALSE) 
  ) %>%
  mutate(ensemble = (ets + snaive + auto) / 3)
```

```{r}
accuracy(miami_dade_long_trips_fit)
```

For the **`Log_Long_Trip`**, comparing the models based on the provided metrics, we can determine the best model. The **`AR.sAR`** model shows a competitive performance with relatively low RMSE and MAE values compared to other models. However, when comparing **`AR.sAR`** with the **`auto`** and **`ets`** models, the **`ets`** model has slightly lower RMSE and MAE values, indicating better predictive accuracy for the **`Log_Long_Trip`** data.

Comparing **`AR.sAR`** for **`Log_Long_Trip`** to the **`auto`** models for **`Log_Short_Trip`** and **`Log_Medium_Trip`**, the **`auto`** model for **`Log_Short_Trip`** outperforms **`AR.sAR`** for **`Log_Long_Trip`** in terms of lower RMSE and MAE values. This suggests that the **`auto`** model is better at capturing the patterns and reducing prediction errors for short trips compared to the **`AR.sAR`** model for long trips.

The **`AR.sAR`** model for **`Log_Long_Trip`** also exhibits a lower ACF1 value than the **`snaive`** model, suggesting less autocorrelation in the residuals and therefore a better model fit. However, the negative ACF1 value for **`AR.sAR`** indicates a potential overcorrection in the model, which could be addressed in model refinement.

### Prediction Intervals

```{r}
# Defining our test set
test = miami_dade_long_trips |> filter_index("2023-01-01" ~ "2023-01-07")

# Generate forecasts with 95% prediction intervals
miami_dade_long_trips_fc <- miami_dade_long_trips_fit %>% 
  forecast(h = length(test$Log_Long_Trips), level = 95)

# Plot the forecasts along with the 95% prediction intervals
autoplot(miami_dade_long_trips_fc) +
  labs(y = "Log Log Trips", title = "Forecasts for daily long trips in Miami-Dade County") +
  guides(colour = guide_legend(title = "Forecast")) +
  geom_line(data = test, aes(x = Date, y = Log_Long_Trips), color = "red") +
  autolayer(test, Log_Long_Trips, colour = "black", linewidth = 0.8)
```

The plot displays forecasted values for daily long trips in Miami-Dade County, with the shaded areas representing 80% and 95% prediction intervals for various models. The models **`auto`**, **`AR.sAR`**, and **`ets`** appear to be closely aligned in their central forecasts, suggesting a consensus in their predictions.

Comparatively, the **`auto`** model has narrower confidence intervals, indicating a higher level of certainty in its forecasts for long trips. This model's forecast line also stays consistently in the middle of the prediction intervals, reflecting a balanced central tendency across the observed time frame.

When juxtaposing this with forecasts for short and medium trips, we can assume that the **`auto`** model has shown the best performance across all trip lengths, consistently providing the most accurate and confident predictions. The **`AR.sAR`** and **`ets`** models, while also among the top performers for long trips, might exhibit more variance in their prediction intervals and may not match the accuracy levels of the **`auto`** model seen in short and medium trip forecasts.

The `AR.sAR` model may be preferred over the automatic ARIMA model due to its explicit handling of seasonality, which can be crucial for data with strong seasonal patterns. It potentially offers greater interpretability, as the model parameters directly relate to identifiable seasonal behaviors in the data. Even if the performance advantage is not immediately evident, the `AR.sAR` model's ability to incorporate known seasonal cycles can lead to more reliable and understandable forecasts, particularly in cases where seasonality is a dominant feature of the time series. Additionally, if the `AR.sAR` model shows more stable performance across different metrics or validation sets, it would suggest a higher degree of robustness, possibly making it a more suitable choice for consistent forecasting.

## Conclusion

In conclusion, our analysis has provided valuable insights into traffic and population movements in Miami-Dade County and Florida as a whole. The models, particularly AR and sAR, have demonstrated their effectiveness in short-term forecasting, which can be instrumental in planning and decision-making processes.

However, there are areas where we can further enhance the robustness and accuracy of our models. Firstly, incorporating more historical data, particularly from years prior to 2019, would provide a broader context and potentially improve the predictive power of our models.

Secondly, having more granular information about the types of travel could allow us to create more nuanced models. While the different time series for various trip types were quite similar in this analysis, understanding the specific characteristics of each travel type could lead to more tailored and accurate models.

Despite these areas for improvement, the current models have proven to be quite effective for short-term forecasting. As we continue to refine our models and incorporate more data, we can expect to gain even deeper insights into the patterns of traffic and population movements in Miami-Dade County and Florida, ultimately aiding in more informed decision-making for transportation planning and policy.
